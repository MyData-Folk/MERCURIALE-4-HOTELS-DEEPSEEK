<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>MERCURIO – Préparation de Commande</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f0f4ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #2563eb);
            transition: all 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            transition: all 0.2s;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            transition: all 0.2s;
        }
        
        .btn-reset:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c7d2fe;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a5b4fc;
        }
    </style>
</head>
<body class="antialiased">
    <div class="min-h-screen flex flex-col py-8 px-4">
        <div class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-xl">
            <!-- Header -->
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-6 text-white rounded-t-xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <a href="index.html" class="mr-4 text-white hover:text-green-200">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <div>
                            <h1 class="text-3xl font-bold flex items-center">
                                <i class="fas fa-shopping-cart mr-3"></i>
                                <span>MERCURIO - Préparation de Commande</span>
                            </h1>
                            <p class="text-green-100 mt-1">Préparez et exportez votre commande fournisseur</p>
                        </div>
                    </div>
                    <div class="hidden md:block">
                        <div class="flex space-x-2">
                            <span class="bg-green-500 text-xs px-3 py-1 rounded-full flex items-center">
                                <i class="fas fa-database mr-1"></i><span>4 sources</span>
                            </span>
                            <span class="bg-green-500 text-xs px-3 py-1 rounded-full flex items-center">
                                <i class="fas fa-boxes mr-1"></i><span id="productCount">0 produits</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="p-6">
                <!-- Search & Filter Section -->
                <div class="mb-8">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                        <div class="flex flex-wrap gap-3">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="source" value="folkestone" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                                <span class="ml-2 text-gray-700 font-medium">Folkestone</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="source" value="vendome" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                                <span class="ml-2 text-gray-700 font-medium">Vendôme</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="source" value="washington" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                                <span class="ml-2 text-gray-700 font-medium">Washington</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="source" value="lehavre" checked class="h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                                <span class="ml-2 text-gray-700 font-medium">Le Havre</span>
                            </label>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="relative w-full sm:w-auto">
                                <select id="searchField" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 py-2 pl-3 pr-10 text-base bg-gray-50">
                                    <option value="all" selected>Tous les champs</option>
                                    <option value="Libellé produit">Libellé produit</option>
                                    <option value="Marque">Marque</option>
                                    <option value="Code Produit">Code Produit</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="searchInput" placeholder="Rechercher un produit, ou plusieurs codes produits séparés par un espace..." autocomplete="off" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Search Results -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-search mr-2 text-indigo-500"></i>Résultats de recherche
                        </h2>
                        <button id="addAllToOrderBtn" class="btn-success text-white px-4 py-2 rounded-md text-sm font-medium flex items-center hidden">
                            <i class="fas fa-cart-plus mr-2"></i>Ajouter tout à la commande
                        </button>
                    </div>
                    <div id="searchResults" class="border border-gray-200 rounded-lg">
                        <p class="text-center text-gray-500 py-8 px-4">Commencez à taper pour rechercher...</p>
                    </div>
                </div>

                <!-- Order Section -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-shopping-cart mr-2 text-indigo-500"></i>Ma commande
                            <span id="orderCount" class="ml-2 bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
                        </h2>
                        <div class="flex space-x-2">
                            <button id="newOrderBtn" class="btn-reset text-white px-4 py-2 rounded-md text-sm font-medium flex items-center">
                                <i class="fas fa-trash-alt mr-2"></i>Nouvelle Commande
                            </button>
                            <button id="downloadCsvBtn" disabled class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-file-csv mr-2"></i>Exporter CSV
                            </button>
                            <button id="downloadXlsxBtn" disabled class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-file-excel mr-2"></i>Exporter Excel
                            </button>
                        </div>
                    </div>
                    <div id="orderList" class="border border-gray-200 rounded-lg">
                        <p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté.</p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 rounded-b-xl">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between text-sm text-gray-500">
                    <div class="flex items-center justify-center md:justify-start mb-2 md:mb-0">
                        <i class="fas fa-info-circle mr-2"></i><span>© 2025 MERCURIO – MyData-Folk</span>
                    </div>
                    <div class="flex items-center justify-center md:justify-end space-x-4">
                        <a href="index.html" class="hover:text-indigo-600"><i class="fas fa-home mr-1"></i>Accueil</a>
                        <a href="compare.html" class="hover:text-indigo-600"><i class="fas fa-chart-line mr-1"></i>Comparer les prix</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const searchInput = document.getElementById('searchInput');
            const searchField = document.getElementById('searchField');
            const sourceCheckboxes = document.querySelectorAll('input[name="source"]');
            const searchResultsContainer = document.getElementById('searchResults');
            const addAllToOrderBtn = document.getElementById('addAllToOrderBtn');
            const orderListContainer = document.getElementById('orderList');
            const downloadCsvBtn = document.getElementById('downloadCsvBtn');
            const downloadXlsxBtn = document.getElementById('downloadXlsxBtn');
            const orderCountElement = document.getElementById('orderCount');
            const productCountElement = document.getElementById('productCount');
            const newOrderBtn = document.getElementById('newOrderBtn');

            // State
            let dataFolkestone = [], dataVendome = [], dataWashington = [], dataLeHavre = [];
            let currentData = [], orderList = [], lastSearchResults = [];
            let visibleColumns = ['Libellé produit', 'Marque', 'Prix'];

            // Load data and initialize
            Promise.all([
                fetch('data/mercuriale-folkestone.json').then(r => r.json()),
                fetch('data/mercuriale-vendome.json').then(r => r.json()),
                fetch('data/mercuriale-washington.json').then(r => r.json()),
                fetch('data/mercuriale-lehavre.json').then(r => r.json())
            ])
            .then(([folkestone, vendome, washington, lehavre]) => {
                dataFolkestone = folkestone.map(x => ({...x, _source: 'Folkestone'}));
                dataVendome = vendome.map(x => ({...x, _source: 'Vendôme'}));
                dataWashington = washington.map(x => ({...x, _source: 'Washington'}));
                dataLeHavre = lehavre.map(x => ({...x, _source: 'Le Havre'}));
                
                // Load order list from localStorage
                const savedOrder = localStorage.getItem('mercurialeOrder');
                orderList = savedOrder ? JSON.parse(savedOrder) : [];
                
                updateCurrentData();
                updateProductCount();
                renderOrderList();
                initializeEventListeners();
            })
            .catch(error => {
                console.error("Erreur de chargement des fichiers JSON:", error);
                searchResultsContainer.innerHTML = `<div class="bg-red-50 border-l-4 border-red-400 p-4"><p class="text-sm text-red-700">Erreur : Impossible de charger les données.</p></div>`;
            });

            function initializeEventListeners() {
                // Search functionality
                searchInput.addEventListener('input', performSearch);
                searchField.addEventListener('change', performSearch);
                
                // Source filters
                sourceCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        updateCurrentData();
                        updateProductCount();
                        performSearch();
                    });
                });
                
                // Add all to order
                addAllToOrderBtn.addEventListener('click', addAllSearchResultsToOrder);
                
                // New order
                newOrderBtn.addEventListener('click', () => {
                    if (confirm("Êtes-vous sûr de vouloir créer une nouvelle commande ? Votre commande actuelle sera perdue.")) {
                        orderList = [];
                        saveOrderToLocalStorage();
                        renderOrderList();
                        showNotification('Nouvelle commande créée', 'success');
                    }
                });
                
                // Export buttons
                downloadCsvBtn.addEventListener('click', () => exportOrder('csv'));
                downloadXlsxBtn.addEventListener('click', () => exportOrder('xlsx'));
            }

            function updateCurrentData() {
                currentData = [];
                if (document.querySelector('input[name="source"][value="folkestone"]').checked) {
                    currentData = currentData.concat(dataFolkestone);
                }
                if (document.querySelector('input[name="source"][value="vendome"]').checked) {
                    currentData = currentData.concat(dataVendome);
                }
                if (document.querySelector('input[name="source"][value="washington"]').checked) {
                    currentData = currentData.concat(dataWashington);
                }
                if (document.querySelector('input[name="source"][value="lehavre"]').checked) {
                    currentData = currentData.concat(dataLeHavre);
                }
            }

            function updateProductCount() {
                const count = currentData.length;
                productCountElement.textContent = `${count.toLocaleString()} produits`;
            }

            function performSearch() {
                const searchTerm = searchInput.value.trim();
                const searchFieldValue = searchField.value;
                
                if (!searchTerm) {
                    searchResultsContainer.innerHTML = '<p class="text-center text-gray-500 py-8 px-4">Commencez à taper pour rechercher...</p>';
                    addAllToOrderBtn.classList.add('hidden');
                    lastSearchResults = [];
                    return;
                }
                
                let results = [];
                
                // Check if search term contains multiple product codes
                if (searchTerm.includes(' ')) {
                    const codes = searchTerm.split(' ').filter(c => c.trim());
                    if (codes.length > 1) {
                        // Search by multiple codes
                        codes.forEach(code => {
                            const codeResults = currentData.filter(product => {
                                return String(product['Code Produit'] ?? '').trim() === code;
                            });
                            results.push(...codeResults);
                        });
                    } else {
                        // Regular search
                        results = performRegularSearch(searchTerm, searchFieldValue);
                    }
                } else {
                    // Regular search
                    results = performRegularSearch(searchTerm, searchFieldValue);
                }
                
                lastSearchResults = results;
                renderSearchResults(results);
                
                // Show/hide "Add all" button
                if (results.length > 0) {
                    addAllToOrderBtn.classList.remove('hidden');
                } else {
                    addAllToOrderBtn.classList.add('hidden');
                }
            }

            function performRegularSearch(searchTerm, searchFieldValue) {
                return currentData.filter(product => {
                    if (searchFieldValue === 'all') {
                        return Object.values(product).some(value => 
                            String(value).toLowerCase().includes(searchTerm.toLowerCase())
                        );
                    } else {
                        const fieldValue = product[searchFieldValue];
                        return fieldValue && String(fieldValue).toLowerCase().includes(searchTerm.toLowerCase());
                    }
                });
            }

            function renderSearchResults(results) {
                if (results.length === 0) {
                    searchResultsContainer.innerHTML = '<p class="text-center text-gray-500 py-8 px-4">Aucun résultat trouvé.</p>';
                    return;
                }
                
                let tableHTML = `
                    <div class="custom-scrollbar" style="max-height: 400px; overflow-y: auto;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Source</th>
                                    ${visibleColumns.map(col => 
                                        `<th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">${col}</th>`
                                    ).join('')}
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                results.forEach(product => {
                    const isInOrderList = orderList.some(item => 
                        item['Code Produit'] === product['Code Produit'] && item._source === product._source
                    );
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                <span class="px-2 py-1 text-xs rounded-full ${getSourceColor(product._source)}">
                                    ${product._source}
                                </span>
                            </td>
                            ${visibleColumns.map(col => {
                                let value = product[col] || '-';
                                if (col === 'Prix') {
                                    value = formatPriceFromFloat(parsePriceAsFloat(value));
                                }
                                return `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${value}</td>`;
                            }).join('')}
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="add-to-order-btn ${isInOrderList ? 'bg-green-500 text-white px-3 py-1 rounded-full text-xs cursor-not-allowed' : 'btn-primary text-white px-3 py-1 rounded-md text-xs'}" 
                                        data-source="${product._source}" 
                                        data-code="${product['Code Produit']}"
                                        ${isInOrderList ? 'disabled' : ''}>
                                    ${isInOrderList ? 
                                        '<i class="fas fa-check mr-1"></i>Déjà ajouté' : 
                                        '<i class="fas fa-plus mr-1"></i>Ajouter'}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `</tbody></table></div>`;
                searchResultsContainer.innerHTML = tableHTML;
                
                // Add event listeners to "Add to order" buttons
                document.querySelectorAll('.add-to-order-btn:not(:disabled)').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const source = e.currentTarget.dataset.source;
                        const code = e.currentTarget.dataset.code;
                        addProductToOrder(source, code);
                    });
                });
            }

            function addAllSearchResultsToOrder() {
                if (lastSearchResults.length === 0) {
                    showNotification('Aucun article à ajouter', 'warning');
                    return;
                }
                
                let addedCount = 0;
                let skippedCount = 0;
                
                lastSearchResults.forEach(product => {
                    const isAlreadyInOrder = orderList.some(item => 
                        item['Code Produit'] === product['Code Produit'] && item._source === product._source
                    );
                    
                    if (!isAlreadyInOrder) {
                        orderList.push({
                            ...product,
                            _quantity: 1
                        });
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                });
                
                saveOrderToLocalStorage();
                renderOrderList();
                renderSearchResults(lastSearchResults);
                
                let message = `${addedCount} article(s) ajouté(s) à la commande`;
                if (skippedCount > 0) {
                    message += `, ${skippedCount} article(s) déjà présent(s)`;
                }
                
                showNotification(message, addedCount > 0 ? 'success' : 'info');
            }

            function addProductToOrder(source, code) {
                const product = currentData.find(p => p._source === source && p['Code Produit'] == code);
                if (!product) return;
                
                // Check if product is already in order list
                const existingIndex = orderList.findIndex(item => 
                    item['Code Produit'] === product['Code Produit'] && item._source === product._source
                );
                
                if (existingIndex !== -1) {
                    showNotification('Ce produit est déjà dans votre commande', 'warning');
                    return;
                }
                
                orderList.push({
                    ...product,
                    _quantity: 1
                });
                saveOrderToLocalStorage();
                renderOrderList();
                renderSearchResults(lastSearchResults);
                showNotification('Produit ajouté à la commande', 'success');
            }

            function renderOrderList() {
                if (orderList.length === 0) {
                    orderListContainer.innerHTML = '<p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté.</p>';
                    orderCountElement.textContent = '0';
                    downloadCsvBtn.disabled = true;
                    downloadXlsxBtn.disabled = true;
                    return;
                }
                
                orderCountElement.textContent = orderList.length;
                downloadCsvBtn.disabled = false;
                downloadXlsxBtn.disabled = false;
                
                let tableHTML = `
                    <div class="custom-scrollbar" style="max-height: 400px; overflow-y: auto;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Source</th>
                                    ${visibleColumns.map(col => 
                                        `<th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">${col}</th>`
                                    ).join('')}
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Quantité</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                let orderTotal = 0;
                
                orderList.forEach((product, index) => {
                    const price = parsePriceAsFloat(product.Prix);
                    const quantity = product._quantity || 1;
                    const total = price * quantity;
                    orderTotal += total;
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                <span class="px-2 py-1 text-xs rounded-full ${getSourceColor(product._source)}">
                                    ${product._source}
                                </span>
                            </td>
                            ${visibleColumns.map(col => {
                                let value = product[col] || '-';
                                if (col === 'Prix') {
                                    value = formatPriceFromFloat(parsePriceAsFloat(value));
                                }
                                return `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${value}</td>`;
                            }).join('')}
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="number" min="1" value="${quantity}" 
                                       class="w-20 px-2 py-1 border border-gray-300 rounded-md text-sm quantity-input"
                                       data-index="${index}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                ${formatPriceFromFloat(total)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-red-600 hover:text-red-900 remove-from-order" data-index="${index}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `</tbody></table></div>`;
                
                // Add total row
                tableHTML += `
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-800">Total de la commande :</span>
                            <span class="text-xl font-bold text-green-700">${formatPriceFromFloat(orderTotal)}</span>
                        </div>
                    </div>
                `;
                
                orderListContainer.innerHTML = tableHTML;
                
                // Add event listeners
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const newQuantity = parseInt(e.target.value) || 1;
                        orderList[index]._quantity = newQuantity;
                        saveOrderToLocalStorage();
                        renderOrderList();
                    });
                });
                
                document.querySelectorAll('.remove-from-order').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        orderList.splice(index, 1);
                        saveOrderToLocalStorage();
                        renderOrderList();
                        renderSearchResults(lastSearchResults);
                        showNotification('Produit retiré de la commande', 'success');
                    });
                });
            }

            function exportOrder(format) {
                if (orderList.length === 0) {
                    showNotification('La commande est vide', 'error');
                    return;
                }
                
                const headers = ['Source', ...visibleColumns, 'Quantité', 'Total'];
                const rows = orderList.map(product => {
                    const price = parsePriceAsFloat(product.Prix);
                    const quantity = product._quantity || 1;
                    const total = price * quantity;
                    
                    const row = [product._source];
                    visibleColumns.forEach(col => {
                        let value = product[col] || '';
                        if (col === 'Prix') {
                            value = price;
                        }
                        row.push(value);
                    });
                    row.push(quantity, total);
                    
                    return row;
                });
                
                if (format === 'csv') {
                    downloadAsCsv([headers, ...rows], 'commande');
                } else {
                    downloadAsExcel([headers, ...rows], 'commande');
                }
            }

            function downloadAsCsv(data, filename) {
                const csvContent = data.map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';')
                ).join('\n');
                
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                downloadBlob(blob, `${filename}_${getFormattedDate()}.csv`);
            }

            function downloadAsExcel(data, filename) {
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Apply styling for Excel
                if (ws['!ref']) {
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let R = range.s.r; R <= range.e.r; R++) {
                        for (let C = range.s.c; C <= range.e.c; C++) {
                            const cell_address = {c: C, r: R};
                            const cell_ref = XLSX.utils.encode_cell(cell_address);
                            if (!ws[cell_ref]) continue;
                            
                            // Header row styling
                            if (R === 0) {
                                ws[cell_ref].s = {
                                    font: { bold: true, color: { rgb: "FFFFFF" } },
                                    fill: { fgColor: { rgb: "059669" } },
                                    alignment: { horizontal: "center" }
                                };
                            }
                            
                            // Price and total columns styling
                            const priceColIndex = visibleColumns.indexOf('Prix') + 1;
                            const totalColIndex = headers.length - 1;
                            
                            if ((C === priceColIndex || C === totalColIndex) && R > 0 && ws[cell_ref].v) {
                                ws[cell_ref].z = '#,##0.00" €"';
                            }
                        }
                    }
                }
                
                // Set column widths
                const colWidths = [
                    { wch: 12 }, // Source
                    ...visibleColumns.map(col => ({ wch: col === 'Libellé produit' ? 40 : 20 })),
                    { wch: 10 }, // Quantité
                    { wch: 12 }  // Total
                ];
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Commande');
                XLSX.writeFile(wb, `${filename}_${getFormattedDate()}.xlsx`);
            }

            // Utility functions
            function saveOrderToLocalStorage() {
                localStorage.setItem('mercurialeOrder', JSON.stringify(orderList));
            }

            function parsePriceAsFloat(priceStr) {
                if (!priceStr) return 0;
                const cleaned = String(priceStr).replace(/[^\d,.]/g, '').replace(',', '.');
                return parseFloat(cleaned) || 0;
            }

            function formatPriceFromFloat(price) {
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(price);
            }

            function getSourceColor(source) {
                switch(source) {
                    case 'Folkestone': return 'bg-blue-100 text-blue-800';
                    case 'Vendôme': return 'bg-purple-100 text-purple-800';
                    case 'Washington': return 'bg-green-100 text-green-800';
                    case 'Le Havre': return 'bg-orange-100 text-orange-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            function getFormattedDate() {
                return new Date().toISOString().slice(0, 10);
            }

            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 
                               type === 'error' ? 'bg-red-500' : 
                               type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
                
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-md shadow-md text-white max-w-sm ${bgColor}`;
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            }
        });
    </script>
</body>
</html>