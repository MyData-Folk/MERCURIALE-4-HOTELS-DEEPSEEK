<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>PrixMaster – Comparateur de Prix Professionnel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                500: '#3B82F6',
                600: '#2563EB',
              },
              secondary: {
                500: '#8B5CF6',
                600: '#7C3AED',
              }
            }
          }
        }
      }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to));
            --tw-gradient-from: #3B82F6;
            --tw-gradient-to: #2563EB;
            transition: all 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to));
            --tw-gradient-from: #8B5CF6;
            --tw-gradient-to: #7C3AED;
            transition: all 0.2s;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to));
            --tw-gradient-from: #EF4444;
            --tw-gradient-to: #DC2626;
            transition: all 0.2s;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to));
            --tw-gradient-from: #10B981;
            --tw-gradient-to: #059669;
            transition: all 0.2s;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #C7D2FE;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #A5B4FC;
        }

        .price-card {
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            padding: 1.5rem;
            transition: all 0.2s;
            background-color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .price-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .price-card-header {
            font-weight: 600;
            color: #3B82F6;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .price-card-value {
            font-size: 1.35rem;
            font-weight: 700;
            color: #111827;
        }

        .notification {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .fade-out {
            animation: fadeOut 0.5s ease-out forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .price-lowest {
            color: #10B981;
            font-weight: bold;
        }

        .price-highest {
            color: #EF4444;
            font-weight: bold;
        }
    </style>
</head>
<body class="antialiased bg-gray-50">
    <div class="min-h-screen flex flex-col py-8 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-7xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary-600 to-blue-600 p-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <a href="index.html" class="text-white hover:text-blue-200 transition-colors">
                            <i class="fas fa-arrow-left text-lg"></i>
                        </a>
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold flex items-center">
                                <i class="fas fa-chart-line mr-3"></i>
                                <span>PRIXMASTER PRO</span>
                            </h1>
                            <p class="text-blue-100 mt-1 text-sm">Comparez les prix entre vos fournisseurs en temps réel</p>
                        </div>
                    </div>
                    <div class="hidden md:flex items-center space-x-3">
                        <span class="bg-blue-500/90 text-xs px-3 py-1.5 rounded-full flex items-center">
                            <i class="fas fa-database mr-1.5"></i><span>4 sources intégrées</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="p-6">
                <!-- Search Section -->
                <div class="mb-8">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-search mr-2 text-primary-500"></i>Rechercher un produit
                    </h2>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-barcode text-gray-400"></i>
                            </div>
                            <input type="text" id="productCodeInput" placeholder="Entrez un code produit (ex: 12345) ou plusieurs codes séparés par un espace..." autocomplete="off" class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                        </div>
                        <button id="searchBtn" class="btn-primary text-white px-6 py-3 rounded-lg text-sm font-medium flex items-center justify-center">
                            <i class="fas fa-search mr-2"></i>Rechercher
                        </button>
                    </div>
                </div>

                <!-- Price Comparison Results -->
                <div id="priceComparisonResults" class="hidden">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-balance-scale mr-2 text-primary-500"></i>Comparaison des prix
                            <span id="resultsCount" class="ml-2 bg-primary-100 text-primary-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
                        </h2>
                        <div class="flex space-x-2">
                            <button id="addAllToComparisonBtn" class="btn-success text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                                <i class="fas fa-plus-circle mr-2"></i>Ajouter tout
                            </button>
                        </div>
                    </div>
                    <div id="priceComparisonCards" class="space-y-6"></div>
                </div>

                <!-- Comparison List -->
                <div id="comparisonListSection" class="mt-8">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                        <h2 class="text-lg font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-primary-500"></i>Liste de comparaison
                            <span id="comparisonCount" class="ml-2 bg-primary-100 text-primary-800 text-xs font-medium px-2.5 py-0.5 rounded-full">0</span>
                        </h2>
                        <div class="flex flex-wrap gap-2">
                            <button id="exportComparisonCsvBtn" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                                <i class="fas fa-file-csv mr-2"></i>CSV
                            </button>
                            <button id="exportComparisonXlsxBtn" class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                                <i class="fas fa-file-excel mr-2"></i>Excel
                            </button>
                            <button id="clearComparisonBtn" class="btn-danger text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                                <i class="fas fa-trash mr-2"></i>Vider
                            </button>
                        </div>
                    </div>
                    <div id="comparisonList" class="border border-gray-200 rounded-lg overflow-hidden">
                        <p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté à la liste de comparaison.</p>
                    </div>
                </div>

                <!-- Clear All Button at Bottom -->
                <div class="mt-6 flex justify-end">
                    <button id="resetAllBtn" class="btn-danger text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i>Effacer tout
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between text-sm text-gray-600">
                    <div class="flex items-center justify-center md:justify-start mb-2 md:mb-0">
                        <i class="fas fa-info-circle mr-2 text-primary-500"></i><span>© 2025 PRIXMASTER PRO – MyData-Folk</span>
                    </div>
                    <div class="flex items-center justify-center md:justify-end space-x-4">
                        <a href="index.html" class="hover:text-primary-600 transition-colors flex items-center">
                            <i class="fas fa-home mr-1.5"></i>Accueil
                        </a>
                        <a href="commande.html" class="hover:text-primary-600 transition-colors flex items-center">
                            <i class="fas fa-shopping-cart mr-1.5"></i>Préparer commande
                        </a>
                        <a href="parametres.html" class="hover:text-primary-600 transition-colors flex items-center">
                            <i class="fas fa-cog mr-1.5"></i>Paramètres
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const productCodeInput = document.getElementById('productCodeInput');
            const searchBtn = document.getElementById('searchBtn');
            const priceComparisonResults = document.getElementById('priceComparisonResults');
            const priceComparisonCards = document.getElementById('priceComparisonCards');
            const addAllToComparisonBtn = document.getElementById('addAllToComparisonBtn');
            const comparisonListSection = document.getElementById('comparisonListSection');
            const comparisonList = document.getElementById('comparisonList');
            const comparisonCount = document.getElementById('comparisonCount');
            const resultsCount = document.getElementById('resultsCount');
            const exportComparisonCsvBtn = document.getElementById('exportComparisonCsvBtn');
            const exportComparisonXlsxBtn = document.getElementById('exportComparisonXlsxBtn');
            const clearComparisonBtn = document.getElementById('clearComparisonBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');

            // State
            let dataFolkestone = [], dataVendome = [], dataWashington = [], dataLeHavre = [];
            let comparisonListData = [];
            let currentSearchResults = [];

            // Load data
            Promise.all([
                fetch('data/mercuriale-folkestone.json').then(r => r.json()),
                fetch('data/mercuriale-vendome.json').then(r => r.json()),
                fetch('data/mercuriale-washington.json').then(r => r.json()),
                fetch('data/mercuriale-lehavre.json').then(r => r.json())
            ])
            .then(([folkestone, vendome, washington, lehavre]) => {
                dataFolkestone = folkestone.map(x => ({...x, _source: 'Folkestone'}));
                dataVendome = vendome.map(x => ({...x, _source: 'Vendôme'}));
                dataWashington = washington.map(x => ({...x, _source: 'Washington'}));
                dataLeHavre = lehavre.map(x => ({...x, _source: 'Le Havre'}));
                
                // Load comparison list from localStorage
                const savedComparison = localStorage.getItem('mercurialeComparison');
                comparisonListData = savedComparison ? JSON.parse(savedComparison) : [];
                renderComparisonList();
            })
            .catch(error => {
                console.error("Erreur de chargement des fichiers JSON:", error);
                showNotification("Erreur de chargement des données", "error");
            });

            // Search functionality
            searchBtn.addEventListener('click', () => {
                const code = productCodeInput.value.trim();
                if (!code) {
                    priceComparisonResults.classList.add('hidden');
                    showNotification("Veuillez saisir un code produit", "error");
                    return;
                }
                
                findProductByCode(code);
            });

            productCodeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });

            function findProductByCode(code) {
                const allData = [...dataFolkestone, ...dataVendome, ...dataWashington, ...dataLeHavre];
                const codes = code.includes(' ') ? code.split(' ').filter(c => c.trim()) : [code];
                
                currentSearchResults = [];
                priceComparisonCards.innerHTML = '';
                
                codes.forEach(currentCode => {
                    const products = allData.filter(p => String(p['Code Produit'] ?? '').trim() === currentCode);
                    if (products.length > 0) {
                        const productGroup = {
                            code: currentCode,
                            name: products[0]['Libellé produit'] || 'Produit inconnu',
                            brand: products[0]['Marque'] || 'Marque inconnue',
                            sources: {}
                        };
                        
                        // Get prices from all sources
                        ['Folkestone', 'Vendôme', 'Washington', 'Le Havre'].forEach(source => {
                            const product = products.find(p => p._source === source);
                            productGroup.sources[source] = product ? {
                                price: parsePriceAsFloat(product.Prix),
                                priceFormatted: formatPriceFromFloat(parsePriceAsFloat(product.Prix)),
                                stock: product['Stock'] || 'N/A'
                            } : null;
                        });
                        
                        currentSearchResults.push(productGroup);
                        
                        // Determine min and max prices for color coding
                        const prices = Object.values(productGroup.sources)
                            .filter(source => source !== null)
                            .map(source => source.price);
                        
                        const minPrice = Math.min(...prices);
                        const maxPrice = Math.max(...prices);
                        
                        // Create comparison card for this product
                        const cardHTML = `
                            <div class="bg-white border border-gray-200 rounded-xl p-5 transition-all hover:shadow-md">
                                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-800">${productGroup.name}</h3>
                                        <div class="flex flex-wrap gap-x-4 gap-y-1 mt-1">
                                            <p class="text-sm text-gray-600">Code: <span class="font-medium">${productGroup.code}</span></p>
                                            <p class="text-sm text-gray-600">Marque: <span class="font-medium">${productGroup.brand}</span></p>
                                        </div>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button class="add-single-to-comparison btn-secondary text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center" data-code="${productGroup.code}">
                                            <i class="fas fa-plus mr-2"></i>Ajouter
                                        </button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    ${['Folkestone', 'Vendôme', 'Washington', 'Le Havre'].map(source => {
                                        const sourceData = productGroup.sources[source];
                                        const price = sourceData ? sourceData.price : null;
                                        const priceClass = price ? 
                                            (price === minPrice ? 'price-lowest' : 
                                             price === maxPrice ? 'price-highest' : '') : '';
                                        
                                        return `
                                            <div class="price-card flex flex-col">
                                                <div class="price-card-header flex items-center">
                                                    <span class="inline-block w-3 h-3 rounded-full mr-2 ${sourceData ? 'bg-green-500' : 'bg-gray-300'}"></span>
                                                    ${source}
                                                </div>
                                                <div class="price-card-value mb-2 ${priceClass}">${sourceData ? sourceData.priceFormatted : '-'}</div>
                                                <div class="text-xs text-gray-500 mt-auto">Stock: ${sourceData ? sourceData.stock : '-'}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                        
                        priceComparisonCards.innerHTML += cardHTML;
                    }
                });
                
                // Update results count
                resultsCount.textContent = currentSearchResults.length;
                
                // Add event listeners to individual add buttons
                document.querySelectorAll('.add-single-to-comparison').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const code = e.target.closest('button').dataset.code;
                        addProductToComparisonList(code);
                    });
                });
                
                if (currentSearchResults.length > 0) {
                    priceComparisonResults.classList.remove('hidden');
                    addAllToComparisonBtn.disabled = false;
                } else {
                    priceComparisonResults.classList.add('hidden');
                    showNotification('Aucun produit trouvé avec ce code', 'warning');
                }
            }

            // Add all products to comparison list
            addAllToComparisonBtn.addEventListener('click', () => {
                currentSearchResults.forEach(product => {
                    addProductToComparisonList(product.code);
                });
                showNotification(`${currentSearchResults.length} produit(s) ajouté(s) à la liste`, 'success');
            });

            function addProductToComparisonList(code) {
                // Check if product is already in comparison list
                if (comparisonListData.some(item => item.code === code)) {
                    showNotification('Ce produit est déjà dans la liste de comparaison', 'warning');
                    return;
                }
                
                const allData = [...dataFolkestone, ...dataVendome, ...dataWashington, ...dataLeHavre];
                const products = allData.filter(p => String(p['Code Produit'] ?? '').trim() === code);
                
                if (products.length === 0) return;
                
                const productDetails = {
                    code: code,
                    name: products[0]['Libellé produit'] || 'Produit inconnu',
                    brand: products[0]['Marque'] || 'Marque inconnue',
                    prices: []
                };
                
                // Get prices from all sources
                ['Folkestone', 'Vendôme', 'Washington', 'Le Havre'].forEach(source => {
                    const product = products.find(p => p._source === source);
                    if (product) {
                        productDetails.prices.push({
                            source: source,
                            price: parsePriceAsFloat(product.Prix),
                            priceFormatted: formatPriceFromFloat(parsePriceAsFloat(product.Prix)),
                            stock: product['Stock'] || 'N/A'
                        });
                    }
                });
                
                comparisonListData.push(productDetails);
                saveComparisonToLocalStorage();
                renderComparisonList();
                showNotification('Produit ajouté à la liste', 'success');
            }

            function renderComparisonList() {
                if (comparisonListData.length === 0) {
                    comparisonListSection.classList.add('hidden');
                    comparisonList.innerHTML = '<p class="text-center text-gray-500 py-8 px-4">Aucun article ajouté à la liste de comparaison.</p>';
                    return;
                }
                
                comparisonListSection.classList.remove('hidden');
                comparisonCount.textContent = comparisonListData.length;
                
                let tableHTML = `
                    <div class="custom-scrollbar" style="max-height: 500px; overflow-y: auto;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0 z-10">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Marque</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Folkestone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendôme</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Washington</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Le Havre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                `;
                
                comparisonListData.forEach((item, index) => {
                    // Find min and max prices for color coding
                    const prices = item.prices.map(p => p.price);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    
                    tableHTML += `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.code}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${item.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.brand}</td>
                            ${['Folkestone', 'Vendôme', 'Washington', 'Le Havre'].map(source => {
                                const priceObj = item.prices.find(p => p.source === source);
                                if (!priceObj) return `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">-</td>`;
                                
                                const priceClass = priceObj.price === minPrice ? 'price-lowest' : 
                                                  priceObj.price === maxPrice ? 'price-highest' : '';
                                
                                return `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${priceClass}">${priceObj.priceFormatted}</td>`;
                            }).join('')}
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex space-x-2">
                                    <button class="text-gray-500 hover:text-primary-600 transition-colors" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="text-red-500 hover:text-red-700 transition-colors remove-from-comparison" data-index="${index}" title="Supprimer">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `</tbody></table></div>`;
                comparisonList.innerHTML = tableHTML;
                
                // Add event listeners to remove buttons
                document.querySelectorAll('.remove-from-comparison').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        comparisonListData.splice(index, 1);
                        saveComparisonToLocalStorage();
                        renderComparisonList();
                        showNotification('Produit retiré de la liste de comparaison', 'success');
                    });
                });
            }

            // Clear comparison list
            clearComparisonBtn.addEventListener('click', () => {
                if (comparisonListData.length === 0) {
                    showNotification('La liste de comparaison est déjà vide', 'warning');
                    return;
                }
                
                if (confirm('Voulez-vous vraiment vider toute la liste de comparaison ?')) {
                    comparisonListData = [];
                    saveComparisonToLocalStorage();
                    renderComparisonList();
                    showNotification('Liste de comparaison vidée', 'success');
                }
            });

            // Reset all (clear search and comparison)
            resetAllBtn.addEventListener('click', () => {
                if (productCodeInput.value || comparisonListData.length > 0) {
                    if (confirm('Voulez-vous vraiment tout réinitialiser ? Cela effacera la recherche et la liste de comparaison.')) {
                        productCodeInput.value = '';
                        priceComparisonResults.classList.add('hidden');
                        comparisonListData = [];
                        saveComparisonToLocalStorage();
                        renderComparisonList();
                        showNotification('Tout a été réinitialisé', 'success');
                    }
                } else {
                    showNotification('Rien à réinitialiser', 'info');
                }
            });

            // Export functions
            exportComparisonCsvBtn.addEventListener('click', () => exportComparisonList('csv'));
            exportComparisonXlsxBtn.addEventListener('click', () => exportComparisonList('xlsx'));

            function exportComparisonList(format) {
                if (comparisonListData.length === 0) {
                    showNotification('La liste de comparaison est vide', 'error');
                    return;
                }
                
                const headers = ['Code', 'Produit', 'Marque', 'Folkestone', 'Vendôme', 'Washington', 'Le Havre'];
                const rows = comparisonListData.map(item => {
                    const getPriceValue = (source) => {
                        const priceObj = item.prices.find(p => p.source === source);
                        return priceObj ? priceObj.price : '';
                    };
                    
                    return [
                        item.code,
                        item.name,
                        item.brand,
                        getPriceValue('Folkestone'),
                        getPriceValue('Vendôme'),
                        getPriceValue('Washington'),
                        getPriceValue('Le Havre')
                    ];
                });
                
                if (format === 'csv') {
                    downloadAsCsv([headers, ...rows], 'comparaison_prix');
                } else {
                    downloadAsExcel([headers, ...rows], 'comparaison_prix');
                }
            }

            function downloadAsCsv(data, filename) {
                const csvContent = data.map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(';')
                ).join('\n');
                
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                downloadBlob(blob, `${filename}_${getFormattedDate()}.csv`);
                showNotification('Export CSV généré avec succès', 'success');
            }

            function downloadAsExcel(data, filename) {
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Apply styling for Excel
                if (ws['!ref']) {
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let R = range.s.r; R <= range.e.r; R++) {
                        for (let C = range.s.c; C <= range.e.c; C++) {
                            const cell_address = {c: C, r: R};
                            const cell_ref = XLSX.utils.encode_cell(cell_address);
                            if (!ws[cell_ref]) continue;
                            
                            // Header row styling
                            if (R === 0) {
                                ws[cell_ref].s = {
                                    font: { bold: true, color: { rgb: "FFFFFF" } },
                                    fill: { fgColor: { rgb: "3B82F6" } },
                                    alignment: { horizontal: "center" }
                                };
                            }
                            
                            // Price columns styling (columns D to G)
                            if (C >= 3 && C <= 6 && R > 0 && ws[cell_ref].v) {
                                ws[cell_ref].z = '#,##0.00" €"';
                            }
                        }
                    }
                }
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 12 }, // Code
                    { wch: 40 }, // Produit
                    { wch: 20 }, // Marque
                    { wch: 12 }, // Folkestone
                    { wch: 12 }, // Vendôme
                    { wch: 12 }, // Washington
                    { wch: 12 }  // Le Havre
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Comparaison Prix');
                XLSX.writeFile(wb, `${filename}_${getFormattedDate()}.xlsx`);
                showNotification('Export Excel généré avec succès', 'success');
            }

            // Utility functions
            function saveComparisonToLocalStorage() {
                localStorage.setItem('mercurialeComparison', JSON.stringify(comparisonListData));
            }

            function parsePriceAsFloat(priceStr) {
                if (!priceStr) return 0;
                const cleaned = String(priceStr).replace(/[^\d,.]/g, '').replace(',', '.');
                return parseFloat(cleaned) || 0;
            }

            function formatPriceFromFloat(price) {
                return new Intl.NumberFormat('fr-FR', {
                    style: 'currency',
                    currency: 'EUR'
                }).format(price);
            }

            function getFormattedDate() {
                return new Date().toISOString().slice(0, 10).replace(/-/g, '');
            }

            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function showNotification(message, type = 'info') {
                // Remove any existing notifications
                document.querySelectorAll('.notification').forEach(el => el.remove());
                
                // Create and show notification
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? 'bg-green-500' : 
                               type === 'error' ? 'bg-red-500' : 
                               type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
                
                notification.className = `notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white max-w-sm flex items-center ${bgColor}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} mr-3"></i>
                    <span class="flex-1">${message}</span>
                `;
                
                document.body.appendChild(notification);
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }, 3000);
            }
        });
    </script>
</body>
</html>